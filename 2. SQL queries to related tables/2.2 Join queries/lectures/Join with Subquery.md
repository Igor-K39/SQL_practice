## Запросы для нескольких таблиц со вложенными запросами

В запросах, построенных на нескольких таблицах, можно использовать вложенные запросы. Вложенный запрос может быть включен:  после ключевого слова SELECT,  после FROM и в условие отбора после WHERE (HAVING).

**Пример 1.** Вывести авторов, общее количество книг которых на складе максимально.

Это достаточно сложный запрос, поэтому будем решать его по шагам (реализуя каждый запрос по отдельности), а потом объединим все запросы в один.

1. Найдем суммарное количество книг на складе по каждому автору. Поскольку фамилии автора в этой таблице нет, то группировку будем осуществлять по author_id.

Запрос:
```sql
SELECT author_id, SUM(amount) AS sum_amount 
  FROM book 
 GROUP BY author_id
```
Результат:
```
+-----------+------------+
| author_id | sum_amount |
+-----------+------------+
| 1         | 8          |
| 2         | 23         |
| 3         | 21         |
| 4         | 2          |
+-----------+------------+
```

2. В результирующей таблице предыдущего запроса необходимо найти максимальное значение, то есть 23. Для этого запросу, созданному на шаге 1, необходимо присвоить имя (например, query_in) и использовать его в качестве таблицы-источника после FROM. Затем уже находить максимум по столбцу sum_amount.

Запрос:  
```sql
SELECT MAX(sum_amount) AS max_sum_amount
  FROM 
      (
       SELECT author_id, SUM(amount) AS sum_amount 
         FROM book 
        GROUP BY author_id
      ) query_in
```
Результат:
```
+----------------+
| max_sum_amount |
+----------------+
| 23             |
+----------------+
```

3. Выведем фамилию автора и общее количество книг для него.

Запрос:  
```sql
SELECT name_author, SUM(amount) AS Количество
  FROM 
       author INNER JOIN book
       ON author.author_id = book.author_id
 GROUP BY name_author
```
Результат:
```
+------------------+------------+
| name_author      | Количество |
+------------------+------------+
| Булгаков М.А.    | 8          |
| Достоевский Ф.М. | 23         |
| Есенин С.А.      | 21         |
| Пастернак Б.Л.   | 2          |
+------------------+------------+
```

4. Включим запрос с шага 2 в условие отбора запроса с шага 3. И получим всех авторов, общее количество книг которых максимально.

Запрос:  
```sql
SELECT name_author, SUM(amount) as Количество
FROM 
    author INNER JOIN book
    on author.author_id = book.author_id
GROUP BY name_author
HAVING SUM(amount) = 
     (/* вычисляем максимальное из общего количества книг каждого автора */
      SELECT MAX(sum_amount) AS max_sum_amount
      FROM 
          (/* считаем количество книг каждого автора */
            SELECT author_id, SUM(amount) AS sum_amount 
            FROM book GROUP BY author_id
          ) query_in
      );
```
Результат:
```
+------------------+------------+
| name_author      | Количество |
+------------------+------------+
| Достоевский Ф.М. | 23         |
+------------------+------------+
```

## Вложенные запросы в операторах соединения

Вложенные запросы могут использоваться в операторах соединения JOIN.  При этом им необходимо присваивать имя, которое записывается сразу после закрывающей скобки вложенного запроса.
```sql
SELECT
 ...
  FROM
      таблица ... JOIN  
      (
       SELECT ...
      ) имя_вложенного_запроса
      ON условие
...
```

Вложенный запрос может стоять как справа, так и слева от оператора JOIN. Допускается использование двух запросов в операторах соединения.

**Пример 2.** Вывести авторов, пишущих книги в самом популярном жанре. Указать этот жанр.

Самым популярным считать жанр, общее количество экземпляров книг которого на складе максимально. Таких жанров может быть несколько, если они имеют одинаковое максимальное значение общего количества экземпляров. Только для этого шага изменена запись в таблице book.
```
book_id  title  author_id  genre_id   price    amount
8        Лирика    4           2      518.9910   10
```
А также добавлены новые записи:
```
book_id  title                author_id  genre_id   price   amount
9        Герой нашего времени   5          3        570.59    2
10       Доктор Живаго          4          3        740.50    5
```

Рассмотрим реализацию этого запроса по шагам.

1. Найдем общее количество книг по каждому жанру, отсортируем его по убыванию и ограничим вывод одной строкой. Рекомендуется, если запрос будет использоваться в качестве вложенного (особенно в операциях соединения), вычисляемым полям запроса давать собственное имя.

Запрос:
```sql
SELECT genre_id, SUM(amount) AS sum_amount
  FROM book
 GROUP BY genre_id
 ORDER BY sum_amount DESC
 LIMIT 1
```
Результат:
```
+---------------+------------+
|  genre_id     | sum_amount |
+---------------+------------+
| 1             | 31         |
+---------------+------------+
```
Кажется, что, уже используя этот запрос, можно получить id самого популярного жанра. Но это не так, поскольку несколько жанров могут иметь одинаковую популярность. Поэтому нам необходим запрос, который отберет ВСЕ жанры, суммарное количество книг которых равно sum_amount.

2. Используя запрос с предыдущего шага, найдем id самых популярных жанров.

Запрос:
```sql
SELECT query_in_1.genre_id
  FROM 
      (/* выбираем код жанра и количество произведений, относящихся к нему */
        SELECT genre_id, SUM(amount) AS sum_amount
          FROM book
         GROUP BY genre_id 
      ) query_in_1
      
      INNER JOIN
      
      (/* выбираем запись, в которой указан код жанр с максимальным количеством книг */
        SELECT genre_id, SUM(amount) AS sum_amount
          FROM book
         GROUP BY genre_id
         ORDER BY sum_amount DESC
         LIMIT 1
      ) query_in_2
     
     ON query_in_1.sum_amount = query_in_2.sum_amount              
```
Результат:
```
+----------+
| genre_id |
+----------+
| 1        |
| 2        |
+----------+
```

3. Используя запрос с шага 2, выведем фамилии авторов, которые пишут в самых популярных жанрах, и названия этих жанров. В этом запросе обязательно выполнить группировку по фамилиям авторов и id жанров, так как без этого фамилии авторов будут повторяться, поскольку в таблице book есть разные книги, написанные автором в одном жанре.

Запрос:
```sql
SELECT name_author, name_genre
  FROM author 
       INNER JOIN book  ON author.author_id = book.author_id
       INNER JOIN genre ON book.genre_id    = genre.genre_id

 GROUP BY name_author,name_genre, genre.genre_id

HAVING genre.genre_id IN
           (/* выбираем автора, если он пишет книги в самых популярных жанрах*/
             SELECT query_in_1.genre_id
               FROM 
                   ( /* выбираем код жанра и количество произведений, относящихся к нему */
                     SELECT genre_id, SUM(amount) AS sum_amount
                       FROM book
                      GROUP BY genre_id
                   ) query_in_1
           
                   INNER JOIN 
              
                   ( /* выбираем запись, в которой указан код жанр с максимальным количеством книг */
                     SELECT genre_id, SUM(amount) AS sum_amount
                       FROM book
                      GROUP BY genre_id
                      ORDER BY sum_amount DESC
                      LIMIT 1
                   ) query_in_2
                   
                   ON query_in_1.sum_amount= query_in_2.sum_amount
           );   
```
### Важно!
Обратите внимание, что в группировку включен столбец genre_id, который используется в HAVING. Это связано с тем, что в HAVING можно использовать либо столбцы, перечисленные в GROUP BY, либо вычисляемые с помощью групповых функций столбцы. Добавление столбца genre_idне влияет на группировку, так как между названием жанра и его id - взаимно-однозначное соответствие.
Название столбца genre_id задается с указанием имени таблицы (genre.genre_id), так как этот столбец входит в структуру двух таблиц book и genre.  Для этого запроса можно было бы указать и book.genre_id, так как эти таблицы связаны внутренним соединением INNER JOIN и имеют одинаковые значения в полях genre.genre_id и book.genre_id.

Результат:
```
+------------------+------------+
| name_author      | name_genre |
+------------------+------------+
| Достоевский Ф.М. | Роман      |
| Булгаков М.А.    | Роман      |
| Пастернак Б.Л.   | Поэзия     |
| Есенин С.А.      | Поэзия     |
+------------------+------------+
```